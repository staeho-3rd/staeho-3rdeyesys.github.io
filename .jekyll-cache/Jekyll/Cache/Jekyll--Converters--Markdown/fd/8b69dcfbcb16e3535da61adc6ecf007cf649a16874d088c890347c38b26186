I"/<h2 id="개요">개요</h2>
<p>네이버 클라우드 VPC 환경의 대표적인 Load Balancer인 Application Load Balancer 를 생성하는 가이드입니다.<br />
VPC와 Subnet을 생성하고, 테스트를 위한 서버 2대를 CentOS와 Ubuntu 각각 1대씩 준비해서 Application Load Balancer와 연결하고 접속해보는 과정까지 정리해보겠습니다.</p>

<h2 id="vpc-생성">VPC 생성</h2>
<p>VPC 환경에서는 먼저 VPC를 먼저 생성해야 하며, 이미 만들어진 VPC가 있다면 그대로 이용하셔도 됩니다.<br />
VPC의 IP 주소 범위는 private 대역 (10.0.0.0/8, 172.160.0./12, 192.168.0.0/16) 내에서 /16 ~ /28 범위여야 합니다.<br />
여기서는 192.168.0.0/16 범위의 VPC를 생성하겠습니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_01.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<h2 id="subnet-생성">Subnet 생성</h2>
<p>Load Balancer를 생성할 때 Server와는 다른 Subnet을 사용해야 정상 작동합니다.<br />
그래서 여기서도 Load Balancer용 Subnet과 테스트 Server용 Subnet을 각각 생성하도록 하겠습니다.</p>

<h4 id="load-balancer용-subnet-생성">Load Balancer용 Subnet 생성</h4>
<p>Load Balancer는 Private Subnet에 위치해야 하므로 192.168.1.0/24 IP 대역에 Internet Gateway 전용 여부 옵션은 N (Private)을 선택합니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_02.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<h4 id="server용-subnet-생성">Server용 Subnet 생성</h4>
<p>일반 서버용 Subnet은 192.168.2.0/24 IP 대역에 Internet Gateway 전용 여부 옵션은 Y (Public)을 선택합니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_03.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<h2 id="테스트용-server-생성">테스트용 Server 생성</h2>
<p>테스트를 위한 서버는 위에서 생성했던 192.168.2.0/24 IP 대역의 Subnet을 선택하고 Network Interface도 동일한 Subnet을 선택합니다.<br />
Load Balancer를 테스트 하기 위한 서버이므로 2대를 생성하면서 1대는 CentOS, 나머지 1대는 Ubunt로 생성하겠습니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_04.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<h2 id="target-group-생성">Target Group 생성</h2>
<p>[VPC] - [Load Balancer] - [Target Group]에서 Load Balancer가 바라보게 될 Target Group를 설정합니다.<br />
여기서는 HTTP 프로토콜과 80 포트를 선택하겠습니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_05.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<p>다음으로 Health Check 설정에서는 HTTP, 80포트, HEAD Method를 선택합니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_06.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<p>마지막으로 Target 즉, 대상이 되는 서버 2대 (lb-test-ubuntu, lb-test-centos)를 선택하고, 적용 Target쪽으로 이동시키는 버튼을 클릭합니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_07.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<p>대상 서버들이 적용 Target으로 설정된 모습입니다. 이후에는 전체 설정을 다시 확인하고 생성 완료를 하면 됩니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_08.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<h2 id="load-balancer-생성">Load Balancer 생성</h2>
<p>네이버 클라우드 VPC 환경에서 제공하는 Load Balancer는 애플리케이션 로드밸런서, 네트워크 로드밸런서, 네트워크 프록시 로드밸런서 이렇게 3가지가 있습니다.<br />
그 중에서 가장 많이 사용하는 HTTP, HTTPS 트래픽을 사용하는 웹 애플리케이션용 Application Load Balancer를 생성하겠습니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_09.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<p>Network는 Public IP, Subnet은 앞에서 생성했던 192.168.1.0/24 대역의 Subnet을 선택합니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_10.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<p>리스너 설정에서 프로토콜은 HTTP, 포트는 80을 선택하고 [추가] 버튼을 클릭합니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_11.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<p>Target Group은 앞에서 생성했던 test-tg을 선택하면, 아래에 해당 Target Group의 설정이 표시됩니다.<br />
다음으로 전체 설정을 다시 확인하고 최종 생성하기 버튼을 클릭하면 Load Balancer가 생성됩니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_12.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<h2 id="network-acl-설정">Network ACL 설정</h2>
<p>Load Balancer가 정상 작동하기 위해서는 2가지 설정이 추가로 필요한데, 우선 Network ACL 설정에서 Load Balancer가 속한 Subnet 대역을 허용해 주어야 합니다.<br />
[VPC] - [Network ACL] - [ACL Rule]에서 [Rule 설정]에 있는 [Inbound 규칙]에 앞에서 생성했던 Load Balancer용 Subnet 대역인 192.168.1.0/24 대역의 80 포트를 허용으로 설정해 줍니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_13.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<h2 id="acg-설정">ACG 설정</h2>
<p>다음으로 [Server] - [ACG]에서 [Inbound 규칙]에 마찬가지로 Load Balancer용 Subnet 대역인 192.168.1.0/24 대역의 80 포트를 허용포트로 설정해 줍니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_14.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<h2 id="server-웹서버-설정">Server 웹서버 설정</h2>
<p>Application Load Balancer를 테스트 하기 위해서는 테스트 Server에 웹서버가 설정되어 있어야 하는데, 네이버 클라우드 VPC 환경에서는 LAMP, LEMP 등의 웹서버가 설정된 이미지를 제공하지 않습니다.<br />
그래서 기본 OS만 설치된 서버에 Apache 웹서버와 php를 설치하도록 하겠습니다. 설치 작업은 아래와 같이 Ubuntu와 CentOS 각각 스크립트를 만들어서 한번에 설치하는 방법을 사용했는데, 필요에 따라서는 하나씩 별도로 설치하셔도 됩니다.</p>

<h4 id="ubuntu에-apache-php-설치하기-스크립트">Ubuntu에 Apache, PHP 설치하기 스크립트</h4>
<p>Apache와 PHP를 설치하고 기본문서 index.html에 서버의 호스트명을 출력하는 스크립트를 적용합니다.</p>

<p>사용한 OS는 Ubuntu 16.04 입니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

apt-get update
apt-get <span class="nb">install </span>apache2 
apt-get <span class="nb">install </span>php
apt-get <span class="nb">install </span>libapache2-mod-php

systemctl start apache2

<span class="nb">cd</span> /var/www/html
<span class="nb">echo</span> <span class="s2">"&lt;?php"</span> <span class="o">&gt;</span> index.html
<span class="nb">echo</span> <span class="s2">"echo </span><span class="se">\"</span><span class="s2">Your server name is </span><span class="se">\"</span><span class="s2">.(gethostname()).</span><span class="se">\"</span><span class="s2">&lt;br&gt;</span><span class="se">\"</span><span class="s2">;"</span> <span class="o">&gt;&gt;</span> index.html
<span class="nb">echo</span> <span class="s2">"?&gt;"</span> <span class="o">&gt;&gt;</span> index.html

<span class="nb">echo </span>AddType application/x-httpd-php .php .php3 .php4 .php5 .html .htm .inc <span class="o">&gt;&gt;</span> phpadd
<span class="nb">cat </span>phpadd <span class="o">&gt;&gt;</span> /etc/apache2/apache2.conf

systemctl restart apache2
systemctl <span class="nb">enable </span>apache2
systemctl status apache2
</code></pre></div></div>
<p><br /></p>

<h4 id="centos에-apache-php-설치하기-스크립트">CentOS에 Apache, PHP 설치하기 스크립트</h4>
<p>사용한 OS는 CentOS 7.3 입니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

yum <span class="nb">install</span> <span class="nt">-y</span> httpd php

systemctl start httpd

<span class="nb">cd</span> /var/www/html
<span class="nb">echo</span> <span class="s2">"&lt;?php"</span> <span class="o">&gt;</span> index.html
<span class="nb">echo</span> <span class="s2">"echo </span><span class="se">\"</span><span class="s2">Your server name is </span><span class="se">\"</span><span class="s2">.(gethostname()).</span><span class="se">\"</span><span class="s2">&lt;br&gt;</span><span class="se">\"</span><span class="s2">;"</span> <span class="o">&gt;&gt;</span> index.html
<span class="nb">echo</span> <span class="s2">"?&gt;"</span> <span class="o">&gt;&gt;</span> index.html

<span class="nb">echo </span>AddType application/x-httpd-php .php .php3 .php4 .php5 .html .htm .inc <span class="o">&gt;&gt;</span> phpadd
<span class="nb">cat </span>phpadd <span class="o">&gt;&gt;</span> /etc/httpd/conf/httpd.conf

systemctl restart httpd
systemctl <span class="nb">enable </span>httpd
systemctl status httpd
</code></pre></div></div>

<h2 id="접속-테스트">접속 테스트</h2>
<p>앞에서 생성했던 Load Balancer 정보에서 접속 정보용 주소를 확인하고 복사합니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_16.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:770px;align:center" /></p>

<p>복사한 Load Balancer 주소를 웹브라우저에 입력하고 계속 새로 고침을 해보면 아래와 같이 CentOS 서버와 Ubuntu에 접속될 때 마다 해당 서버의 호스트명이 출력되면서 Load Balancer가 정상 작동하는 것을 확인할 수 있습니다.</p>

<p><img src="../../images/ncp_networking_load_balancer_application_15-1.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:560px;align:center" /></p>

<p><img src="../../images/ncp_networking_load_balancer_application_15-2.jpg" alt="네이버 클라우드 VPC 환경의 Application Load Balancer 생성하기 " style="width:560px;align:center" /></p>

<h2 id="참고-url">참고 URL</h2>
<ol>
  <li>Application Load Balancer 가이드
    <ul>
      <li><a href="https://guide.ncloud-docs.com/docs/networking-loadbalancer-applicationlbconsole" target="_blank" style="word-break:break-all;">https://guide.ncloud-docs.com/docs/networking-loadbalancer-applicationlbconsole</a></li>
    </ul>
  </li>
  <li>Target Group 가이드
    <ul>
      <li><a href="https://guide.ncloud-docs.com/docs/networking-loadbalancer-targetgroupconsole" target="_blank" style="word-break:break-all;">https://guide.ncloud-docs.com/docs/networking-loadbalancer-targetgroupconsole</a></li>
    </ul>
  </li>
</ol>
:ET